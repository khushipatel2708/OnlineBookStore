<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="jakarta.faces.facelets">

<h:head>
    <title>Order Confirmation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        body { background: #f2f4f7; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .box { max-width: 720px; margin: 50px auto; padding: 30px 35px; border-radius: 15px; background: #fff; box-shadow: 0px 6px 20px rgba(0,0,0,0.12);}
        .title { text-align: center; font-size: 30px; font-weight: 700; margin-bottom: 30px; color: #333;}
        .table th, .table td { vertical-align: middle; }
        .table th { background-color: #f8f9fa; font-weight: 600; }
        .charges { font-size: 20px; text-align: right; margin-top: 20px; }
        .charges b { font-weight: 600; }
        .charges .total-amount { display: block; font-size: 22px; margin-top: 10px; color: #28a745; font-weight: 700; }
        .btn-row { display: flex; justify-content: space-between; gap: 10px; margin-top: 30px; }
        .pay-btn, .cod-btn { flex: 1; padding: 12px 0; font-size: 17px; font-weight: 600; border-radius: 8px; border: none; cursor: pointer; transition: all 0.3s ease; }
        .pay-btn { background-color: #28a745; color: #fff; }
        .pay-btn:hover { background-color: #218838; }
        .cod-btn { background-color: #ffc107; color: #212529; }
        .cod-btn:hover { background-color: #e0a800; }
    </style>
</h:head>

<h:body>
<div class="sticky-header-wrapper">
    <ui:include src="/header.xhtml" /> 
</div>

<h:form id="cartForm">
    <div class="box">
        <div class="title">Confirm Your Order</div>

        <!-- Table -->
        <table class="table table-bordered text-center">
            <thead>
                <tr>
                    <th>Book Name</th>
                    <th>Total Price</th>
                </tr>
            </thead>
            <tbody>
                <ui:repeat value="#{cartBean.cartItems}" var="c">
                    <tr>
                        <td>#{c.bookId.bookname}</td>
                        <td>₹#{c.bookId.price * c.quantity}</td>
                    </tr>
                </ui:repeat>
            </tbody>
        </table>

        <!-- Total Area -->
        <div class="charges">
            Delivery Charge: <b>₹30</b>
            <span class="total-amount">Total Amount: ₹#{cartBean.finalTotal}</span>
        </div>

        <!-- Shipping Button -->
        <h:commandLink value="#{shippingBean.isExisting ? 'Edit Shipping Address' : 'Add Shipping Address'}"
                       action="#{shippingBean.goToShippingPage}"
                       style="font-size:16px; font-weight:600; text-decoration:none; display:block; text-align:center; margin-bottom:20px;" />

        <!-- Buttons -->
        <div class="btn-row">
            <h:commandButton value="Online Payment" 
                             styleClass="pay-btn"
                             action="#{cartBean.goToPayment}"
                             onclick="return confirmAction('online');" />

            <!-- Visible COD button (only triggers SweetAlert) -->
            <button type="button" class="cod-btn" onclick="confirmAction('cod');">
                Cash on Delivery
            </button>

            <!-- Hidden JSF COD button to actually submit the action -->
            <h:commandButton id="hiddenCodBtn" value="Hidden COD" 
                             action="#{cartBean.cashOnDelivery}" 
                             style="display:none;" />
        </div>
    </div>
</h:form>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    var shippingExists = "#{shippingBean.isExisting}" === 'true';

    function confirmAction(type) {
        if (!shippingExists) {
            Swal.fire({
                icon: 'warning',
                title: 'No Shipping Address',
                text: 'Please add a shipping address before proceeding.'
            });
            return false;
        }

        if (type === 'online') {
            return true; // Online payment allowed
        }

        if (type === 'cod') {
            Swal.fire({
                title: 'Are you sure?',
                text: 'Confirm Cash on Delivery?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes',
                cancelButtonText: 'No'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Trigger hidden JSF button
                    document.getElementById('cartForm:hiddenCodBtn').click();
                }
            });
        }
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</h:body>
</html>
