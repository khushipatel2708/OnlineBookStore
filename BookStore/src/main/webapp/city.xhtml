<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:ui="jakarta.faces.facelets"
      xmlns:f="jakarta.faces.core">

    <h:head>
        <title>Manage Cities</title>

        <!-- Bootstrap & Icons -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
        <link rel="stylesheet"
              href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
        <link rel="stylesheet" href="css/adminCss.css"/>
        <link rel="stylesheet" href="css/sidebar_header_css.css"/>

        <!-- Same CSS copied from your reference admin design -->
        <style>
            .btn-add-city {
                background-color: #0d6efd;
                color: white;
                padding: 10px 15px;
                border-radius: 8px;
                font-weight: 600;
                border: none;
                cursor: pointer;
            }

            .data-table-container {
                background-color: #ffffff;
                border-radius: 8px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                overflow: hidden;
                border: 1px solid #e9eef2;
            }

            .city-table {
                width: 100%;
                border-collapse: collapse;
            }

            .city-table th {
                background-color: #f8f9fa;
                font-weight: 600;
                color: #343a40;
                padding: 12px 15px;
                text-align: left;
                border-bottom: 1px solid #dee2e6;
            }

            .city-table td {
                padding: 12px 15px;
                border-bottom: 1px solid #eee;
            }

            .action-icon {
                padding: 5px 8px;
                border: 1px solid #ced4da;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9em;
                margin-right: 5px;
                transition: background-color 0.2s;
            }

            .action-icon:hover {
                background-color: #f0f0f0;
            }

            .edit-icon {
                color: #0d6efd;
            }
            .delete-icon {
                color: #dc3545;
            }
            #jakarta_faces_developmentstage_messages {
                display: none !important;
            }
        </style>
    </h:head>

    <h:body>
        <h:panelGroup rendered="#{not bookBean.admin}">
            <div class="form-card">
                <h2 style="color:#dc3545;">Access Denied! ðŸ›‘</h2>
                <p>You must be an **Admin** to access Add or Edit Book functionalities.</p>
                <h:link value="Go Back to User View" outcome="user.xhtml" />
            </div>
        </h:panelGroup>
        <h:panelGroup rendered="#{bookBean.admin}">

            <!-- Sticky Header -->
            <div class="sticky-header-wrapper">
                <ui:include src="/adminHeader.xhtml"/>
            </div>

            <div class="main-layout">

                <!-- Sidebar -->
                <ui:include src="sidebar.xhtml"/>

                <!-- MAIN CONTENT -->
                <div class="main-content">

                    <h:panelGroup rendered="#{cityBean.admin}">

                        <h:form>

                            <div class="content-header">
                                <h2 class="page-title">Manage Cities</h2>

                                <h:commandButton value="+ Add City"
                                                 action="#{cityBean.resetForm}"
                                                 styleClass="btn-add-city">
                                    <f:ajax render="cityModalForm"
                                            onevent="function(){
                                            new bootstrap.Modal(document.getElementById('cityModal')).show();
                                            }"/>
                                </h:commandButton>
                            </div>

                            <!-- City Table -->
                            <div class="data-table-container">
                                <h:dataTable value="#{cityBean.pagedGroups}" var="c" styleClass="city-table"  rendered="#{not empty cityBean.pagedGroups}">


                                    <h:column>
                                        <f:facet name="header">ID</f:facet>
                                            #{(cityBean.pageNumber - 1) * cityBean.pageSize + cityBean.pagedGroups.indexOf(c) + 1}
                                    </h:column>

                                    <h:column>
                                        <f:facet name="header">City Name</f:facet>
                                            #{c.name}
                                    </h:column>

                                    <h:column>
                                        <f:facet name="header">Actions</f:facet>

                                        <h:commandButton value="&#x270E;"
                                                         action="#{cityBean.editCity(c.id)}"
                                                         styleClass="action-icon edit-icon"
                                                         title="Edit">
                                            <f:ajax execute="@this" render="cityModalForm"
                                                    onevent="function(){
                                                    new bootstrap.Modal(document.getElementById('cityModal')).show();
                                                    }"/>
                                        </h:commandButton>

                                        <!-- DELETE BUTTON WITH SWEETALERT2 -->
                                        <h:commandButton value="&#x1F5D1;"
                                                         action="#{cityBean.deleteCity(c.id)}"
                                                         onclick="deleteConfirm(event, this)"
                                                         styleClass="action-icon delete-icon"
                                                         title="Delete"/>
                                    </h:column>
                                    <!--<h:column>
                                                                    <f:facet name="header">Actions</f:facet>
                                    
                                                                     EDIT BUTTON 
                                                                    <h:commandLink  action="#{cityBean.editCity(c.id)}"
                                                                                   styleClass="btn btn-sm p-1"
                                                                                   title="Edit">
                                                                        <i class="bi bi-pencil-square text-success fs-5"></i>
                                                                    </h:commandLink>
                                    
                                                                     DELETE BUTTON 
                                                                    <h:commandLink   action="#{cityBean.deleteCity(c.id)}"
                                                                                    onclick="return confirm('Delete this Book Type?')"
                                                                                    styleClass="btn btn-sm p-1"
                                                                                    title="Delete">
                                                                        <i class="bi bi-trash text-danger fs-5"></i>
                                                                    </h:commandLink>
                                                                </h:column>-->


                                </h:dataTable>
                                <!-- If no orders, show a message -->
                                <h:panelGroup rendered="#{empty cityBean.pagedGroups}" layout="block" styleClass="text-center p-4">
                                    <h:graphicImage value="images/city.png" style="width:150px; margin-bottom:15px;" />
                                    <div style="font-size:18px; font-weight:600; color:#6c757d;">
                                        No City available
                                    </div>
                                </h:panelGroup>
                                <!-- Pagination Controls -->

                                <div class="pagination-container d-flex justify-content-center mt-4">

                                    <ul class="premium-pagination">

                                        <!-- Previous -->
                                        <li class="#{cityBean.pageNumber == 1 ? 'disabled' : ''}">
                                            <h:commandLink action="#{cityBean.previousPage}">
                                                <f:ajax render="@form"/>
                                                <i class="bi bi-chevron-left"></i> 
                                            </h:commandLink>
                                        </li>

                                        <!-- Page Display -->
                                        <li class="active">
                                            <span>
                                                #{cityBean.pageNumber} / #{cityBean.totalPages}
                                            </span>
                                        </li>

                                        <!-- Next -->
                                        <li class="#{cityBean.pageNumber == cityBean.totalPages ? 'disabled' : ''}">
                                            <h:commandLink action="#{cityBean.nextPage}">
                                                <f:ajax render="@form"/>
                                                <i class="bi bi-chevron-right"></i>
                                            </h:commandLink>
                                        </li>

                                    </ul>

                                </div>
                            </div>

                        </h:form>

                        <!-- MODAL FORM -->
                        <div class="modal fade" id="cityModal">
                            <div class="modal-dialog">
                                <div class="modal-content">

                                    <h:form id="cityModalForm">
                                        <div class="modal-header">
                                            <h5 class="modal-title">
                                                <h:panelGroup rendered="#{not cityBean.editMode}">Add City</h:panelGroup>
                                                <h:panelGroup rendered="#{cityBean.editMode}">
                                                    Edit City
                                                </h:panelGroup>
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="FixBackdrop()"></button>
                                        </div>

                                        <div class="modal-body">
                                            <label>City Name:</label>

                                            <h:inputText id="cityName"
                                                         value="#{cityBean.name}"
                                                         required="true"
                                                         requiredMessage="City is required"
                                                         styleClass="form-control #{not empty facesContext.messageList ? 'is-invalid' : ''}">
                                                <f:ajax event="keyup" render="cityName cityNameMessage"/>
                                            </h:inputText>

                                            <h:message id="cityNameMessage"
                                                       for="cityName"
                                                       styleClass="invalid-feedback d-block"
                                                       style="color:red; font-size:14px;"/>


                                        </div>


                                        <div class="modal-footer">

                                            <!-- Add City Button -->
                                            <h:panelGroup rendered="#{not cityBean.editMode}">
                                                <h:commandButton value="Add City" styleClass="btn btn-success"
                                                                 action="#{cityBean.addCity}">
                                                    <f:ajax execute="cityModalForm" render="cityModalForm"/>
                                                </h:commandButton>
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="FixBackdrop()">
                                                    Cancel
                                                </button>
                                            </h:panelGroup>

                                            <!-- Update City -->
                                            <h:panelGroup rendered="#{cityBean.editMode}">
                                                <h:commandButton value="Update" styleClass="btn btn-primary"
                                                                 action="#{cityBean.updateCity}">
                                                    <f:ajax execute="cityModalForm" render="cityModalForm"/>
                                                </h:commandButton>


                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="FixBackdrop()">
                                                    Cancel
                                                </button>
                                            </h:panelGroup>

                                        </div>

                                    </h:form>

                                </div>
                            </div>
                        </div>

                    </h:panelGroup>

                    <h:panelGroup rendered="#{not cityBean.admin}">
                        <div class="alert alert-danger">Only admin can manage cities.</div>
                    </h:panelGroup>

                </div>

            </div>
        </h:panelGroup>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    </h:body>


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
                                                function deleteConfirm(event, button) {
                                                    event.preventDefault();

                                                    Swal.fire({
                                                        title: 'Are you sure?',
                                                        text: "This city will be permanently deleted!",
                                                        icon: 'warning',
                                                        showCancelButton: true,
                                                        confirmButtonColor: '#dc3545',
                                                        cancelButtonColor: '#6c757d',
                                                        confirmButtonText: 'Yes, delete it!',
                                                        cancelButtonText: 'Cancel'
                                                    }).then((result) => {
                                                        if (result.isConfirmed) {
                                                            button.onclick = null; // prevent SweetAlert loop
                                                            button.click();        // submit JSF delete
                                                        }
                                                    });
                                                }
                                                function FixBackdrop() {
                                                    document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
                                                    document.body.classList.remove('modal-open');
                                                    document.body.style.removeProperty('overflow');
                                                    document.body.style.removeProperty('padding-right');
                                                }
    </script>


</html>
